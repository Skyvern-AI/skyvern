"""drop most foreign keys

Revision ID: e8285b6ddcf0
Revises: 511d9da18f5d
Create Date: 2025-05-02 11:48:31.191371+00:00

"""

from typing import Sequence, Union

from alembic import op
from sqlalchemy import inspect

# revision identifiers, used by Alembic.
revision: str = "e8285b6ddcf0"
down_revision: Union[str, None] = "511d9da18f5d"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("actions") as batch_op:
        pass # No foreign keys to drop on actions table

    with op.batch_alter_table("artifacts") as batch_op:
        pass # No foreign keys to drop on artifacts table

    with op.batch_alter_table("aws_secret_parameters") as batch_op:
        pass # No foreign keys to drop on aws_secret_parameters table

    with op.batch_alter_table("bitwarden_credit_card_data_parameters") as batch_op:
        pass
        # batch_op.drop_constraint(
        #     "bitwarden_credit_card_data_parameters_workflow_id_fkey",
        #     type_="foreignkey",
        # )

    with op.batch_alter_table("bitwarden_login_credential_parameters") as batch_op:
        pass
        # batch_op.drop_constraint(
        #     "bitwarden_login_credential_parameters_workflow_id_fkey",
        #     type_="foreignkey",
        # )

    with op.batch_alter_table("bitwarden_sensitive_information_parameters") as batch_op:
        pass
        # batch_op.drop_constraint(
        #     "bitwarden_sensitive_information_parameters_workflow_id_fkey",
        #     type_="foreignkey",
        # )

    with op.batch_alter_table("credential_parameters") as batch_op:
        pass

def safe_drop_constraint(batch_op, table_name, constraint_name):
    inspector = inspect(batch_op.impl.connection)
    try:
        batch_op.drop_constraint(constraint_name, type_="foreignkey")
    except ValueError as e:
        print(f"Skipping drop of {constraint_name} on {table_name}: {e}")

# Then in your upgrade function:

    with op.batch_alter_table("observer_cruises") as batch_op:
        safe_drop_constraint(batch_op, "observer_cruises", "observer_cruises_workflow_run_id_fkey")
        safe_drop_constraint(batch_op, "observer_cruises", "observer_cruises_workflow_id_fkey")
        safe_drop_constraint(batch_op, "observer_cruises", "observer_cruises_organization_id_fkey")

    with op.batch_alter_table("observer_thoughts") as batch_op:
        batch_op.drop_constraint("observer_thoughts_workflow_run_id_fkey", type_="foreignkey")
        batch_op.drop_constraint("observer_thoughts_workflow_id_fkey", type_="foreignkey")
        batch_op.drop_constraint("observer_thoughts_observer_cruise_id_fkey", type_="foreignkey")
        batch_op.drop_constraint("observer_thoughts_organization_id_fkey", type_="foreignkey")
        batch_op.drop_constraint("observer_thoughts_workflow_run_block_id_fkey", type_="foreignkey")

    with op.batch_alter_table("output_parameters") as batch_op:
        batch_op.drop_constraint("output_parameters_workflow_id_fkey", type_="foreignkey")

    with op.batch_alter_table("persistent_browser_sessions") as batch_op:
        batch_op.drop_constraint(
            "persistent_browser_sessions_organization_id_fkey", type_="foreignkey"
        )

    with op.batch_alter_table("task_generations") as batch_op:
        batch_op.drop_constraint("task_generations_organization_id_fkey", type_="foreignkey")

    with op.batch_alter_table("workflow_parameters") as batch_op:
        batch_op.drop_constraint("workflow_parameters_workflow_id_fkey", type_="foreignkey")

    with op.batch_alter_table("workflow_run_blocks") as batch_op:
        batch_op.drop_constraint("workflow_run_blocks_task_id_fkey", type_="foreignkey")
        batch_op.drop_constraint("workflow_run_blocks_organization_id_fkey", type_="foreignkey")
        batch_op.drop_constraint(
            "workflow_run_blocks_parent_workflow_run_block_id_fkey", type_="foreignkey"
        )
        batch_op.drop_constraint("workflow_run_blocks_block_workflow_run_id_fkey", type_="foreignkey")
        batch_op.drop_constraint("workflow_run_blocks_workflow_run_id_fkey", type_="foreignkey")

    with op.batch_alter_table("workflow_run_output_parameters") as batch_op:
        batch_op.drop_constraint(
            "workflow_run_output_parameters_output_parameter_id_fkey", type_="foreignkey"
        )
        batch_op.drop_constraint(
            "workflow_run_output_parameters_workflow_run_id_fkey", type_="foreignkey"
        )

    with op.batch_alter_table("workflow_run_parameters") as batch_op:
        batch_op.drop_constraint("workflow_run_parameters_workflow_run_id_fkey", type_="foreignkey")
        batch_op.drop_constraint(
            "workflow_run_parameters_workflow_parameter_id_fkey", type_="foreignkey"
        )

    with op.batch_alter_table("workflow_runs") as batch_op:
        batch_op.drop_constraint("workflow_runs_workflow_id_fkey", type_="foreignkey")
        batch_op.drop_constraint("fk_workflow_runs_organization_id", type_="foreignkey")
        batch_op.drop_constraint("workflow_runs_parent_workflow_run_id_fkey", type_="foreignkey")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("workflow_runs") as batch_op:
        batch_op.create_foreign_key(
            "workflow_runs_parent_workflow_run_id_fkey",
            "workflow_runs",
            ["parent_workflow_run_id"],
            ["workflow_run_id"],
        )
        batch_op.create_foreign_key(
            "fk_workflow_runs_organization_id", "organizations", ["organization_id"], ["organization_id"]
        )
        batch_op.create_foreign_key(
            "workflow_runs_workflow_id_fkey", "workflows", ["workflow_id"], ["workflow_id"]
        )

    with op.batch_alter_table("workflow_run_parameters") as batch_op:
        batch_op.create_foreign_key(
            "workflow_run_parameters_workflow_parameter_id_fkey",
            "workflow_parameters",
            ["workflow_parameter_id"],
            ["workflow_parameter_id"],
        )
        batch_op.create_foreign_key(
            "workflow_run_parameters_workflow_run_id_fkey",
            "workflow_runs",
            ["workflow_run_id"],
            ["workflow_run_id"],
        )

    with op.batch_alter_table("workflow_run_output_parameters") as batch_op:
        batch_op.create_foreign_key(
            "workflow_run_output_parameters_workflow_run_id_fkey",
            "workflow_runs",
            ["workflow_run_id"],
            ["workflow_run_id"],
        )
        batch_op.create_foreign_key(
            "workflow_run_output_parameters_output_parameter_id_fkey",
            "output_parameters",
            ["output_parameter_id"],
            ["output_parameter_id"],
        )

    with op.batch_alter_table("workflow_run_blocks") as batch_op:
        batch_op.create_foreign_key(
            "workflow_run_blocks_workflow_run_id_fkey",
            "workflow_runs",
            ["workflow_run_id"],
            ["workflow_run_id"],
        )
        batch_op.create_foreign_key(
            "workflow_run_blocks_block_workflow_run_id_fkey",
            "workflow_runs",
            ["block_workflow_run_id"],
            ["workflow_run_id"],
        )
        batch_op.create_foreign_key(
            "workflow_run_blocks_parent_workflow_run_block_id_fkey",
            "workflow_run_blocks",
            ["parent_workflow_run_block_id"],
            ["workflow_run_block_id"],
        )
        batch_op.create_foreign_key(
            "workflow_run_blocks_organization_id_fkey",
            "organizations",
            ["organization_id"],
            ["organization_id"],
        )
        batch_op.create_foreign_key("workflow_run_blocks_task_id_fkey", "tasks", ["task_id"], ["task_id"])

    with op.batch_alter_table("workflow_parameters") as batch_op:
        batch_op.create_foreign_key("workflow_parameters_workflow_id_fkey", "workflows", ["workflow_id"], ["workflow_id"])

    with op.batch_alter_table("task_generations") as batch_op:
        batch_op.create_foreign_key(
            "task_generations_organization_id_fkey",
            "organizations",
            ["organization_id"],
            ["organization_id"],
        )

    with op.batch_alter_table("persistent_browser_sessions") as batch_op:
        batch_op.create_foreign_key(
            "persistent_browser_sessions_organization_id_fkey",
            "organizations",
            ["organization_id"],
            ["organization_id"],
        )

    with op.batch_alter_table("output_parameters") as batch_op:
        batch_op.create_foreign_key("output_parameters_workflow_id_fkey", "workflows", ["workflow_id"], ["workflow_id"])

    with op.batch_alter_table("observer_thoughts") as batch_op:
        batch_op.create_foreign_key(
            "observer_thoughts_workflow_run_block_id_fkey",
            "workflow_run_blocks",
            ["workflow_run_block_id"],
            ["workflow_run_block_id"],
        )
        batch_op.create_foreign_key(
            "observer_thoughts_organization_id_fkey",
            "organizations",
            ["organization_id"],
            ["organization_id"],
        )
        batch_op.create_foreign_key(
            "observer_thoughts_observer_cruise_id_fkey",
            "observer_cruises",
            ["observer_cruise_id"],
            ["observer_cruise_id"],
        )
        batch_op.create_foreign_key(
            "observer_thoughts_workflow_id_fkey", "workflows", ["workflow_id"], ["workflow_id"]
        )
        batch_op.create_foreign_key(
            "observer_thoughts_workflow_run_id_fkey",
            "workflow_runs",
            ["workflow_run_id"],
            ["workflow_run_id"],
        )

    with op.batch_alter_table("observer_cruises") as batch_op:
        batch_op.create_foreign_key(
            "observer_cruises_organization_id_fkey",
            "organizations",
            ["organization_id"],
            ["organization_id"],
        )
        batch_op.create_foreign_key(
            "observer_cruises_workflow_id_fkey", "workflows", ["workflow_id"], ["workflow_id"]
        )
        batch_op.create_foreign_key(
            "observer_cruises_workflow_run_id_fkey",
            "workflow_runs",
            ["workflow_run_id"],
            ["workflow_run_id"],
        )

    with op.batch_alter_table("credential_parameters") as batch_op:
        batch_op.create_foreign_key("credential_parameters_workflow_id_fkey", "workflows", ["workflow_id"], ["workflow_id"])

    with op.batch_alter_table("bitwarden_sensitive_information_parameters") as batch_op:
        batch_op.create_foreign_key(
            "bitwarden_sensitive_information_parameters_workflow_id_fkey",
            "workflows",
            ["workflow_id"],
            ["workflow_id"],
        )

    with op.batch_alter_table("bitwarden_login_credential_parameters") as batch_op:
        batch_op.create_foreign_key(
            "bitwarden_login_credential_parameters_workflow_id_fkey",
            "workflows",
            ["workflow_id"],
            ["workflow_id"],
        )

    with op.batch_alter_table("bitwarden_credit_card_data_parameters") as batch_op:
        batch_op.create_foreign_key(
            "bitwarden_credit_card_data_parameters_workflow_id_fkey",
            "workflows",
            ["workflow_id"],
            ["workflow_id"],
        )

    with op.batch_alter_table("aws_secret_parameters") as batch_op:
        batch_op.create_foreign_key("aws_secret_parameters_workflow_id_fkey", "workflows", ["workflow_id"], ["workflow_id"])

    with op.batch_alter_table("artifacts") as batch_op:
        batch_op.create_foreign_key("artifacts_step_id_fkey", "steps", ["step_id"], ["step_id"])
        batch_op.create_foreign_key("artifacts_task_id_fkey", "tasks", ["task_id"], ["task_id"])

    with op.batch_alter_table("actions") as batch_op:
        batch_op.create_foreign_key(
            "actions_organization_id_fkey", "organizations", ["organization_id"], ["organization_id"]
        )
        batch_op.create_foreign_key(
            "actions_workflow_run_id_fkey", "workflow_runs", ["workflow_run_id"], ["workflow_run_id"]
        )
        batch_op.create_foreign_key("actions_source_action_id_fkey", "actions", ["source_action_id"], ["action_id"])
        batch_op.create_foreign_key("actions_task_id_fkey", "tasks", ["task_id"], ["task_id"])
        batch_op.create_foreign_key("actions_step_id_fkey", "steps", ["step_id"], ["step_id"])
    # ### end Alembic commands ###
